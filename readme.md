# Redis ê¸°ì´ˆë¶€í„° í™œìš©ê¹Œì§€
## í•™ìŠµ ê³¼ì •
1. ê¸°ë³¸ êµ¬ì¡°(Key-Value) ë° Get, Set ì‚¬ìš©ë²• [o]
2. Redisë¥¼ ì‚¬ìš©í•˜ëŠ” API êµ¬ì¶• [o]
3. Keysapceì™€ Redisì˜ ë©”ëª¨ë¦¬ ê´€ë¦¬ ë°©ì‹ [o]
4. ë°ì´í„° ì˜ì†í™”(AOF, RDB) [o]
5. Indexingê³¼ Caching í™œìš© [o] 
    - Redisë¥¼ ìºì‹± ê³„ì¸µìœ¼ë¡œ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì˜ ì„±ëŠ¥ í–¥ìƒ
6. TTLì™€ LRU ì•Œê³ ë¦¬ì¦˜ ì´í•´ [o]
7. ê¸°íƒ€ ìë£Œêµ¬ì¡° í™œìš© (Hsah, List, Set, Sorted Set) [o]
8. ìºì‹± ì •ì±… - ì •ì /ë™ì  ìºì‹± ì°¨ì´ [o]
9. Cahce Stampede ë°©ì§€ - ì ê¸ˆ ìºì‹± [o]
10. Lock êµ¬í˜„ ë° ë™ì‹œì„± ì´ìŠˆ í•´ê²° [o]
11. SETNXì™€ EXPIREë¡œ ë¶„ì‚° LOCK êµ¬í˜„ [o]
12. Redlock ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë°ì´í„° ì •í•©ì„± ë³´ì¥ []
13. ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ì ‘ê·¼í•  ë•Œ ìƒê¸¸ ìˆ˜ ìˆëŠ” ë°ì´í„° ì¶©ëŒ í•´ê²° []
14. Redis íŠ¸ëœì­ì…˜(MULTI/EXEC) []
15. Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•œ Lock êµ¬í˜„ []
16. Distributed Consensus ì•Œê³ ë¦¬ì¦˜ (ex. Paxos, Raft) []
17. Rate limitìœ¼ë¡œ ì„œë²„ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ []
18. Redisë¥¼ í™œìš©í•œ íŠ¸ë˜í”½ ì œí•œì„ í†µí•´ ì„œë²„ ì•ˆì •ì„±ì„ í™•ë³´ []
19. INCR ëª…ë ¹ì–´ì™€ Sliding Window ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìš”ì²­ ì œí•œ []
20. Rate Limitingì„ í†µí•´ API í˜¸ì¶œ ë¹ˆë„ ì œì–´ []
21. ì„œë²„ ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ ì‚¬ìš©ìë³„ ì œí•œ ì„¤ì • []
22.Token Bucket, Leaky Bucket ì•Œê³ ë¦¬ì¦˜ []
23. Redis Pub/Subì„ í†µí•œ ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬í˜„ []
24. Redis Streamsë¥¼ í™œìš©í•œ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë° []
25. Redis ìš´ì˜ ë° í™•ì¥ []
26. Replication(ë³µì œ): ì½ê¸° ì„±ëŠ¥ ìµœì í™”, master-slave êµ¬ì¡° []
27. Cluster ëª¨ë“œ: ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ í™•ì¥ì„±ì„ ì§€ì› []
28. Persistence(ì˜ì†ì„±): RDB ìŠ¤ëƒ…ìƒ·ê³¼ AOF(append-only file)ë¡œ ë°ì´í„° ë³µì› []
29. Pub/Sub: ì‹¤ì‹œê°„ ì±„íŒ…, ì•Œë¦¼ êµ¬í˜„ []
30. Redis Streams: ë¡œê·¸ ì²˜ë¦¬, ì´ë²¤íŠ¸ ì†Œì‹± []
31. RedisBloom: Bloom í•„í„°ë¡œ íš¨ìœ¨ì  ë°ì´í„° í•„í„°ë§ []
32. ë³´ì•ˆê³¼ ì„±ëŠ¥ 
  - Redis ì¸ì¦ ë° ì‚¬ìš©ì ê´€ë¦¬ []
33. Redisì˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§(RedisInsight, INFO ëª…ë ¹ì–´) []
34. ë©”ëª¨ë¦¬ ìµœì í™” ê¸°ë²• []

# Docker ë¥¼ ì´ìš©í•œ Redis ì„¸íŒ…

1. ë„ì»¤ì— Redisë¥¼ ì„¤ì¹˜í•œë‹¤
    
    ```jsx
    docker --version // ë„ì»¤ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    ```
    
2. docker-compose.yml ì‘ì„±
    
    ```jsx
    version: '3.8' # Docker Compose ë²„ì „
    services:
      redis:
        image: redis:latest # Redis Docker ì´ë¯¸ì§€
        container_name: redis-server # ì»¨í…Œì´ë„ˆ ì´ë¦„
        ports:
          - "6379:6379" # í˜¸ìŠ¤íŠ¸:ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë°”ì¸ë”©
        volumes:
          - redis-data:/data # ë°ì´í„° ì˜ì†ì„±ì„ ìœ„í•œ ë³¼ë¥¨ ë§ˆìš´íŠ¸
        command: ["redis-server", "--appendonly", "yes"] # Redis ì„¤ì • ë³€ê²½ (ì˜ˆ: ì˜ì†ì„± í™œì„±í™”)
    
    volumes:
      redis-data: # ë°ì´í„° ì €ì¥ ë³¼ë¥¨
    
    ```
    
3. docker-compose ì‹¤í–‰
    
    ```jsx
    docker-compose up -d
    ```
    
4. ì‹¤í–‰ í™•ì¸
    
    ```jsx
    docker ps // ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¤‘ì— redisê°€ ìˆëŠ”ì§€ í™•ì¸
    ```
    
    ![image.png](./assets/dockerComposeUpRedis.png)
    
5. redis-clië¥¼ í†µí•œ ì—°ê²° ê°€ëŠ¥
    
    ```jsx
    docker exec -it redis-server redis-cli
    ```
    
6. ë°ì´í„° ì˜ì†ì„± í™•ì¸
    - docker-compose.ymlì—ì„œ ì„¤ì •í•œ redis-data ë³¼ë¥¨ì„ ì‚¬ìš©í•˜ë©´ Redis ë°ì´í„°ë¥¼ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì–´ë„ ì €ì¥ ê°€ëŠ¥
    
    ```jsx
    docker volume inspect redis-data
    ```
    

# ê¸°ë³¸ ì‚¬ìš©ë²•

```jsx
// í‚¤ ê°€ì ¸ì˜¤ê¸°
Get keyname
// ëª¨ë“  í‚¤ ê°€ì ¸ì˜¤ê¸°
Keys *
// í‚¤ ë„£ê¸°
Set keyname data
// í‚¤ ì‚­ì œ
del keyname
// í‚¤ ìŠ¤í˜ì´ìŠ¤ ì •ë³´
info keyspace
// ë©”ëª¨ë¦¬ ì •ë³´ í™•ì¸
Memory Stats
```

# **Keyspaceì™€ Redisì˜ ë©”ëª¨ë¦¬ ê´€ë¦¬ ë°©ì‹**

## Redisì—ì„œ í‚¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ë²•

í‚¤ ìœ íš¨ì‹œê°„

ìŠ¤ìºë‹

altering

qurying

binary safeí•˜ê¸° ë•Œë¬¸ì— ì–´ë–¤ binary sequenceë“  í‚¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤

## í‚¤ ê·œì¹™

ë§¤ìš° ê¸´ í‚¤ëŠ” ì¢‹ì§€ ì•Šë‹¤. í° ê°’ ë§¤ì¹­ì´ í•„ìš”í•˜ë‹¤ë©´ í•´ì‹±í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤

ë©”ëª¨ë¦¬ ê´€ì 

í‚¤ë¥¼ ë¹„êµí•˜ëŠ” ë¹„ìš© ê´€ì 

ë§¤ìš° ì§§ì€ í‚¤ ë˜í•œ ì¢…ì¢… ì¢‹ì€ ë°©ë²•ì€ ì•„ë‹ˆë‹¤

ê°€ë…ì„± ì¸¡ë©´

ex) user:1000:folowersë¥¼ u1000flwë¡œ ì¤„ì´ëŠ” ê²ƒì€ ë©”ëª¨ë¦¬ë¥¼ ì•„ì£¼ ì¡°ê¸ˆ ì¤„ì—¬ì¤„ ë¿ì´ë‹¤.

ìŠ¤í‚¤ë§ˆ í˜•íƒœë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤

ex) object-type:id í˜•íƒœ (user:1000)

. ì´ë‚˜ -ë¥¼ ì‚¬ìš©í•´ multi-word fieldë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤

ìµœëŒ€ í‚¤ ì‚¬ì´ì¦ˆëŠ” 512MBì´ë‹¤

## Altering and querying the key space

### EXISTS

0, 1ë¡œ ì¡´ì¬ ì—¬ë¶€ë¥¼ ì•Œë ¤ì¤Œ

ìˆë‹¤ == 1

ì—†ë‹¤ == 0 

### DEL

ì‚­ì œ ì„±ê³µ ì—¬ë¶€ë¥¼ ìˆ«ìë¡œ ì•Œë ¤ ì¤€ë‹¤.

ì„±ê³µ == 1

ì‹¤íŒ¨ == 0

### TYPE

íƒ€ì…ì„ ì•Œë ¤ì¤€ë‹¤.

type ë°˜í™˜

ì—†ìœ¼ë©´ == none

## Key expiration

í‚¤ì— ëŒ€í•œ TTL(Time To Live)ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤

second, millisecondë¡œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤

expire ì •ë³´ëŠ” redisì— ì €ì¥ëœë‹¤

```jsx
> set code 123 EX 30 // codeì˜ ë§Œë£Œê¸°ê°„ì€ 30ì´ˆì´ë‹¤
> time // ì´ ëª…ë ¹ì–´ë¥¼ í†µí•´ msë‹¨ìœ„ë¡œ ëª‡ ì´ˆ ë‚¨ì•˜ëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤
```

### ë©”ëª¨ë¦¬ ê´€ë¦¬

RedisëŠ” LRU (Least Recently Used) ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•´ ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•œë‹¤.

# ë°ì´í„° ì˜ì†í™” (RDB, AOF)

![image.png](./assets/EX-RDB-AOF.png)

RedisëŠ” In-memoryDBì„ì—ë„ ë¶ˆêµ¬í•˜ê³  ë©”ëª¨ë¦¬ ë°ì´í„°ë¥¼ disckì— ì €ì¥í•  ìˆ˜ ìˆë‹¤

ì„œë²„ë¥¼ ê»ë‹¤ ì¼œë„ diskì— ì €ì¥í•œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì½ì–´ ë©”ëª¨ë¦¬ì— ë¡œë”©ì‹œì¼œ ë°ì´í„° ìœ ì‹¤ì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.

ì´ëŸ° ì˜ì†ì„± ê¸°ëŠ¥ì€ íœ˜ë°œì„± ë©”ëª¨ë¦¬ DBë¥¼ ë°ì´í„° ìŠ¤í† ì–´ë¡œ í™œìš©í•œë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ ì´ ê¸°ëŠ¥ ë•Œë¬¸ì— `ì¥ì• ì˜ ì£¼ì›ì¸`ì´ ë˜ê¸°ë„ í•œë‹¤.

## RDB

ê´€ê³„í˜• DBë¥¼ ì¤„ì¸ ë§ì´ ì•„ë‹ˆë‹¤

Redis DBì˜ ì¤„ì¸ë§ì´ë‹¤

ì´ ë°©ë²•ì€ ì§€ì •ëœ ê°„ê²©ìœ¼ë¡œ ë°ì´í„°ì˜ ìŠ¤ëƒ…ìƒ·ì„ ì°ì–´ ì €ì¥í•œë‹¤

ì¦‰, í˜„ì¬ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ë°ì´í„° ìƒíƒœë“¤ì„ íŠ¹ì • ì‹œì ì— ì €ì¥í•˜ëŠ” ë°©ë²•

### ì¥ì 

RDBëŠ” ë§¤ìš° ì••ì¶•ëœ íŠ¹ì • ì‹œê°„ì— ëŒ€í•œ ë©”ëª¨ë¦¬ ìƒíƒœ(ë°ì´í„°)ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

ex) ì‹œê°„ë§ˆë‹¤ ë˜ëŠ” ë§¤ì¼ ìŠ¤ëƒ…ìƒ·ì„ í†µí•´ Redisì— ì •ì• ê°€ ë°œìƒí•œ ê²½ìš° ì›í•˜ëŠ” íŠ¹ì • ì§€ì ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆë‹¤

ìŠ¤ëƒ…ìƒ·ì€ ë°”ì´ë„ˆë¦¬ í˜•íƒœë¡œ ì €ì¥ì´ ë˜ì–´ ì§ì ‘ ì½ì„ ìˆœ ì—†ë‹¤

ë³„ë„ì˜ ì €ì¥ì†Œë¡œ ë³´ë‚¼ ìˆ˜ ìˆëŠ” `ë‹¨ì¼ ì••ì¶• íŒŒì¼`ì´ê¸° ë•Œë¬¸ì— ì¬í•´ ë³µêµ¬ì— ì¢‹ë‹¤

### ë‹¨ì 

ë°ì´í„° ì†ì‹¤ì„ ìµœì†Œí™” í•´ì•¼ í•˜ëŠ” ê²½ìš° ì¢‹ì§€ ì•Šë‹¤.

íŠ¹ì • ì‹œê°„ë§ˆë‹¤ í˜„ì¬ì˜ ë©”ëª¨ë¦¬ ë°ì´í„° ìŠ¤ëƒ…ìƒ·ì„ ì°ì–´ ì˜ì†í™”í•˜ê¸° ë•Œë¬¸

### RDB ì„¤ì • í•­ëª©

| ì„¤ì • í•­ëª© | ì„¤ì • ì‚¬ë¡€ | ì„¤ëª… |
| --- | --- | --- |
| save | 900 1 | 900ì´ˆ(15ë¶„) ì´í›„ 1ê°œì˜ ì“°ê¸° ë°œìƒ |
| save | 300 10 | 300ì´ˆ(3ë¶„) ì´í›„ 10ê°œì˜ ì“°ê¸° ë°œìƒ |
| save | 60 10000 | 60ì´ˆ ì´í›„ 10,000ê°œì˜ ì“°ê¸° ë°œìƒì‹œ ë””ìŠ¤í¬ì— ë°ì´í„° ë³µì œ |
| stop-writes-on-bgsave-error | yes | - RDS ìŠ¤ëƒ…ìƒ· ì¤‘ ì“°ê¸° ìš”ì²­ ì¤‘ë‹¨ì˜µì…˜ 
- ë ˆë””ìŠ¤ ì„œë²„ ë° Disk ì§€ì†ì„œì— ëŒ€í•œ ì ì ˆí•œ ëª¨ë‹ˆí„°ë§ ì²´ê³„ë¥¼ ê°–ì·„ë‹¤ë©´ â€˜noâ€™ë¡œ ì§€ì •í•´ ì‚¬ìš© ê°€ëŠ¥ |
| rdbcompression | yes | dump.rds íŒŒì¼ì„ LZFë¡œ ì••ì¶• |
| rdbchecksum | yes  | - CRC64ë¡œ Checksum ê°’ ìƒì„±í›„ dump.rds íŒŒì¼ì— ì¶”ê°€
- ë°ì´í„° ì˜ì†ì„± ë³´ì¥ì´ ê°•í™”ë˜ë‚˜ 10% ì •ë„ì˜ ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ ë°œìƒ |
| dbfilename | dump.rdb | ë³€ê²½ ì§€ì • ê°€ëŠ¥ |
| dir | ./ | dump.rdb íŒŒì¼ê³¼ AOF íŒŒì¼ ìƒì„± ìœ„ì§€ |

## ì €ì¥ ì‹œì  ì •í•˜ê¸°

ì €ì¥ ë°©ì‹ì—ëŠ” SAVEì™€ BGSAVE ë‘ê°€ì§€ê°€ ìˆë‹¤

`SAVE`

ìˆœê°„ì ìœ¼ë¡œ redisì˜ ë™ì‘ì„ ì •ì§€ì‹œí‚¤ê³  ê·¸ snapshotì„ ë””ìŠ¤í¬ì— ì €ì¥.(blocking ë°©ì‹)

ë™ì‘ ìˆœì„œ

1. Main processê°€ ë°ì´í„°ë¥¼ ìƒˆ RDB temp íŒŒì¼ì— ì“´ë‹¤.
2. ì“°ê¸°ê°€ ëë‚˜ë©´ ê¸°ì¡´ íŒŒì¼ì„ ì§€ìš°ê³ , ìƒˆíŒŒì¼ë¡œ êµì²´í•œë‹¤.

`BGSAVE`

ë°±ê·¸ë¼ìš´ë“œ SAVEë¼ëŠ” ì˜ë¯¸ë¡œ ë³„ë„ì˜ ìì‹ í”„ë¡œì„¸ìŠ¤ë¥¼ ë„ìš´ í›„, ëª…ë ¹ì–´ ìˆ˜í–‰ ë‹¹ì‹œì˜ snapshotì„ ì €ì¥í•˜ê³ , redisëŠ” ë™ì‘ì„ ë©ˆì¶”ì§€ ì•Šê²Œ ëœë‹¤. (non-blocking ë°©ì‹)

ë™ì‘ìˆœì„œ

1. Child processë¥¼ fork()í•œë‹¤.
2. Child processëŠ” ë°í„°ë¥¼ ìƒˆ RDB temp íŒŒì¼ì— ì“´ë‹¤.
3. ì“°ê¸°ê°€ ëë‚˜ë©´ ê¸°ì¡´ íŒŒì¼ì„ ì§€ìš°ê³ , ì´ë¦„ì„ ë³€ê²½í•œë‹¤.

SAVE ì¡°ê±´ì€ ì—¬ëŸ¬ ê°œë¥¼ ì§€ì •í•  ìˆ˜ ìˆê³ , AND || OR ì´ë‹¤

ì¦‰, ì–´ëŠ ê²ƒ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ì €ì¥í•œë‹¤.

ë§Œì¼ RDB ì €ì¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë ¤ë©´ redis.confì—ì„œ SAVEë¥¼ ëª¨ë‘ ì£¼ì„ ì²˜ë¦¬í•˜ë©´ ëœë‹¤.

> BGSAVE ë°©ì‹ì€ forkë¥¼ í•˜ê¸° ë•Œë¬¸ì— ë©”ëª¨ë¦¬ë¥¼ ê±°ì˜ ë‘ ë°° ê°€ëŸ‰ ì‚¬ìš©í•˜ë¯€ë¡œ ì´ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.
> 

```jsx
save [Seconds][Changes]
save 900 1 // 900ì´ˆ(15ë¶„) ë™ì•ˆ 1ë²ˆ ì´ìƒ key ë³€ê²½ì´ ë°œìƒí•˜ë©´ ì €ì¥
save 300 10 // 300ì´ˆ(5ë¶„) ë™ì•ˆ 10ë²ˆ ì´ìƒ key ë³€ê²½ì´ ë°œìƒí•˜ë©´ ì €ì¥
save 60 10000 // 60ì´ˆ(1ë¶„) ë™ì•ˆ 10,000ë²ˆ ì´ìƒ key ë³€ê²½ì´ ë°œìƒí•˜ë©´ ì €ì¥
```

### RDB íŒŒì¼ëª… ì§€ì •

ë””ë ‰í† ë¦¬ëŠ” dirë¡œ ì§€ì •ëœ ì›Œí‚¹ ë””ë ‰í† ë¦¬ë¥¼ ë”°ë¥¸ë‹¤.

```jsx
dbfilename dump.rdb
```

### RDB ì €ì¥ ì‹¤íŒ¨ì‹œ ë°ì´í„° ì½ê¸° ì—¬ë¶€

RDB íŒŒì¼ ì €ì¥ì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ë°ì´í„°ë¥¼ ë°›ì•„ ë“¤ì¼ì§€ ë§ì§€ë¥¼ ì •í•˜ëŠ” íŒŒë¼ì´í„°

```jsx
stop-writes-on-bgsave-error yes
```

ì´ ê°’ì´ `yes`ì¼ ë•Œ, ë ˆë””ìŠ¤ëŠ” RDB íŒŒì¼ì„ ë””ìŠ¤í¬ì— ì €ì¥í•˜ë‹¤ ì‹¤íŒ¨í•˜ë©´, ëª¨ë“  ì“°ê¸° ìš”ì²­ì„ ê±°ë¶€í•œë‹¤. `DefaultëŠ” yes`ì´ë‹¤

ì´ ê°’ì„ `no` ë¡œ ì„¤ì •í•˜ë©´ ë””ìŠ¤í¬ ì €ì¥ì— ì‹¤íŒ¨í•˜ë”ë¼ë„, ë ˆë””ìŠ¤ëŠ” ì“°ê¸° ìš”ì²­ì„ í¬í•¨í•œ ëª¨ë“  ë™ì‘ì„ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

ë””ìŠ¤í¬ ì“°ê¸°ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°ëŠ” ì—¬ìœ  ê³µê°„ì´ ë¶€ì¡±í•˜ê±°ë‚˜, ê¶Œí•œ(permission) ë¶€ì¡±, ë””ìŠ¤í¬ ë¬¼ë¦¬ì  ì˜¤ë¥˜ ë“±ì´ ìˆì„ ìˆ˜ ìˆë‹¤.

ì´ íŒŒë¼ë¯¸í„°ëŠ” `SAVE ì´ë²¤íŠ¸ì—ë§Œ í•´ë‹¹`í•œë‹¤. BGSAVE ëª…ë ¹ì„ ì§ì ‘ ì…ë ¥í–ˆì„ ë•ŒëŠ” í•´ë‹¹ x

### RDB ê´€ë ¨ Info ì¡°íšŒ

```jsx
info persistence

//ì¶œë ¥
loading:0
async_loading:0
current_cow_peak:0
current_cow_size:0
current_cow_size_age:0
current_fork_perc:0.00
current_save_keys_processed:0
current_save_keys_total:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1737955327
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_saves:0
rdb_last_cow_size:0
rdb_last_load_keys_expired:0
rdb_last_load_keys_loaded:0
aof_enabled:1
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_rewrites:0
aof_rewrites_consecutive_failures:0
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0
aof_current_size:88
aof_base_size:88
aof_pending_rewrite:0
aof_buffer_length:0
aof_pending_bio_fsync:0
aof_delayed_fsync:0
```

### ìˆ˜ë™ SAVE í•˜ê¸°

redis.conf íŒŒì¼ì— ì„¤ì •í•´ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ë§Œë“¤ ìˆ˜ ìˆì§€ë§Œ, ì§ì ‘ í„°ë¯¸ë„ì—ì„œ ëª…ë ¹ìœ¼ë¡œ RDBíŒŒì¼ì„ ìˆ˜ë™ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

```jsx
> BGSAVE

//ì¶œë ¥
127.0.0.1:6379> BGSAVE
Background saving started
```

## AOF (Append Only File)

Write /Update ì‘ì—…ì´ ì¼ì–´ë‚  ë•Œë§ˆë‹¤ Fileì— ë¡œê·¸ì²˜ëŸ¼ í•´ë‹¹ ëª…ë ¹ì´ ê¸°ë¡ ëœë‹¤.
Redisê°€ ì‚´ì•„ë‚¬ì„ ë•Œ ê¸°ë¡ëœ ì‘ì—…ì„ ë‹¤ì‹œ ì¬ìƒí•´ì„œ ë³µêµ¬í•œë‹¤.

ë‹¤ìŒ ìˆœì„œë¡œ ë°ì´í„°ê°€ ì €ì¥ëœë‹¤.

1. Clientì˜ ì—…ë°ì´íŠ¸ ê´€ë ¨ ëª…ë ¹ ìš”ì²­
2. RedisëŠ” í•´ë‹¹ ëª…ë ¹ì„ AOFì— ì €ì¥
3. íŒŒì¼ì“°ê¸°ê°€ ì™„ë£Œ í›„ Redisë©”ëª¨ë¦¬ ë‚´ìš© ë³€ê²½

ì—°ì‚°ì´ ë°œìƒí•  ë•Œë§ˆë‹¤ ë§¤ë²ˆ ê¸°ë¡

RDB ë°©ì‹ê³¼ëŠ” ë‹¬ë¦¬ íŠ¹ì • ì‹œì ì´ ì•„ë‹ˆë¼ í•­ìƒ í˜„ì¬ê¹Œì§€ì˜ ë¡œê·¸ë¥¼ ê¸°ë¡í•  ìˆ˜ ìˆìœ¼ë©°,
ê¸°ë³¸ì ìœ¼ë¡œ non-blackingìœ¼ë¡œ ë™ì‘ëœë‹¤.

### ì¥ì 

ì“°ê¸° ì‘ì—…ë§ˆë‹¤ ê¸°ë¡ì´ ë˜ê¸° ë•Œë¬¸ì—, ë°ì´í„° ì†ì‹¤ë¥ ì´ RDBë³´ë‹¤ í˜„ì €íˆ ì ë‹¤

FLUSH ALL ëª…ë ¹ì–´ë¥¼ ì‹¤ìˆ˜ë¡œ ì‚¬ìš©í•œ ê²½ìš° AOF íŒŒì¼ì— ê¸°ë¡ëœ FLUSH ALLë§Œ ì œê±°í•˜ê³ , ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ë©´, ê°€ì¥ ìµœì‹ ì˜ ë°ì´í„° ìƒíƒœë¡œ ë³µêµ¬ê°€ ê°€ëŠ¥í•œë‹¤.

RDBëŠ” ë°”ì´ë„ˆë¦¬ íŒŒì¼ì´ë¼ì„œ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í–ˆì§€ë§Œ, AOF ë¡œê·¸ íŒŒì¼ì€ text íŒŒì¼ì´ë¯€ë¡œ í¸ì§‘ ê°€ëŠ¥

### ë‹¨ì 

ë™ì¼í•œ ì‹œì ì˜ ë°ì´í„°ë¼ë„ ëª¨ë“  ì—°ì‚°ì„ ë¡œê·¸ë¡œ ë‹¤ ë‚¨ê¸°ê¸° ë•Œë¬¸ì— RDBë³´ë‹¤ AOFê°€ ë” í¬ë‹¤

ì¬ì‹œì‘ì‹œ ëª¨ë“  ì €ì¥ ëœ ì—°ì‚°ì„ ë‹¤ì‹œ ì‹¤í–‰í•´ì„œ í•´ì„œ RDBë³´ë‹¤ AOFê°€ ë” ëŠë¦¬ë‹¤

### Redis ë°ì´í„° ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

ë§Œì•½ ì‹¤ìˆ˜ë¡œ flushall ëª…ë ¹ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ìˆëŠ” ëª¨ë“  ë°ì´í„°ë¥¼ ë‚ ë ¸ì„ ë•Œ,  Redisì„œë²„ë¥¼ shutdowní•˜ê³  appendonly.aof íŒŒì¼ì—ì„œ flushall ëª…ë ¹ì„ ì œê±°í•œ ìˆ˜ Redisë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë°ì´í„° ì†ì‹¤ ì—†ì´ ë°ì´í„°ë¥¼ ì‚´ë¦´ ìˆ˜ ìˆë‹¤

### AOF Rewrite

RewriteëŠ” í˜„ì¬ AOFì— ê¸°ë¡ëœ write ì‘ì—…ì„ í†µí•´ ê°€ì¥ ìµœê·¼ì˜ ë°ì´í„°ë¡œ ë³µêµ¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ìµœì†Œí•œì˜ ì‘ì—…ì´ ê¸°ë¡ëœ ìƒˆë¡œìš´ íŒŒì¼ì€ ë§Œë“œëŠ” ê²ƒì„ ëœ»í•¨

ì¦‰, ì´ì „ ê¸°ë¡ì€ ëª¨ë‘ ì‚¬ë¼ì§€ê³  ìµœì¢… ë°ì´í„°ì— ëŒ€í•œ ê¸°ë¡ë§Œ ìˆë‹¤

ë°±ê·¸ë¼ìš´ë“œì—ì„œ rewrite ì‘ì—…ì´ ì¼ì–´ë‚˜ê²Œ ëœë‹¤

ì¦‰, ë°±ê·¸ë¼ìš´ë“œì—ì„œ rewriteë¥¼ í•˜ê³ , ì´ë¥¼ í˜„ì¬ ë ˆë””ìŠ¤ê°€ ê¸°ë¡ì¤‘ì¸ AOF íŒŒì¼ê³¼ ì „í™˜í•œë‹¤.

### Fsync

ìš´ì˜ì²´ì œ ë²„í¼ì—ì„œ ì‹¤ì œ ë””ìŠ¤í¬ë¡œ ì €ì¥í•˜ë„ë¡ í•˜ëŠ” ëª…ë ¹ì–´

`always`

ìƒˆë¡œìš´ ëª…ë ¹ì´ AOFì—  ì¶”ê°€ë  ë•Œë§ˆë‹¤ fsyncë¥¼ ìˆ˜í–‰í•œë‹¤.

ë§¤ìš° ëŠë¦¬ë‹¤

`every sec`

ë§¤ì´ˆë§ˆë‹¤ fsyncë¥¼ ìˆ˜í–‰í•œë‹¤.

ì¶©ë¶„íˆ ë¹ ë¥´ë‹¤

`no`

OSì—ê²Œ fsyncë¥¼ ë§¡ê¸´ë‹¤.

LinuxëŠ” ë³´í†µ 30ì´ˆë§ˆë‹¤ fsyncë¥¼ í•œë‹¤.

### AOF ì‚¬ìš©ë²•

| ì„¤ì • í•­ëª© | ì„¤ì • ì‚¬ë¡€ | ì„¤ëª… |
| --- | --- | --- |
| appendonly | yes | AOF íŒŒì¼ ì‚¬ìš© ì—¬ë¶€ |
| appendfilename | â€œappendonly.aof | AOF íŒŒì¼ ì´ë¦„ ì§€ì • |
| appendfsync | always | ìš´ì˜ì²´ì œì˜ fsync()ì— ì˜í•´ ì§€ì—°ëœ ì“°ê¸° ì˜µì…˜ (ë©”ëª¨ë¦¬ â†’ Disk)
- no : fsync() ì‚¬ìš©ì—†ì´ ì¦‰ì‹œ ì“°ê¸°, ê°€ì¥ ë¹ ë¦„
- always : í•­ìƒ fsync() ì‚¬ìš©, ëŠë¦¬ì§€ë§Œ ì•ˆì „í•¨
- everysec : ë§¤ ì´ˆë§ˆë‹¤ fsync() í˜¸ì¶œ |
| no-appendfsync-on-rewrite | no | ì“°ê¸° ëª…ë ¹ì— ëŒ€í•œ fsync() ë¦¬í„´ ì§€ì—° ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìš´ì˜ì²´ì œì˜ ê°„ì„­ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ìŠ¤ëƒ…ìƒ· ìƒì„±ì„ ìœ„í•œ BGSAVE ë˜ëŠ” AOFíŒŒì¼ ê¸°ë¡ì„ ìœ„í•œ BGREWIRTEAOFê°€ ì‹¤í–‰ë˜ê³  ìˆì„ ë•ŒëŠ” fsync()ì˜ í˜¸ì¶œì„ ë¸”ë¡í‚¹í•¨ |
| auto-aof-rewrite-percentage | 100 | AOF íŒŒì¼ ì´ˆê¸°í™” ë° ì¬ê¸°ë¡ ì‹œì‘ì„ ìœ„í•´ ìµœë¡œ AOF íŒŒì¼ì˜ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš© ë¹„ìœ¨ì„ ì§€ì •(â€™0â€™ìœ¼ë¡œ ì§€ì •ì‹œ AOF íŒŒì¼ ì´ˆê¸°í™” ì—†ìŒ) |
| auto-aof-rewirte-min-size | 64mb | AOF íŒŒì¼ ì´ˆê¸°í™” ë° ì¬ê¸°ë¡ ì‹œì‘ì„ ìœ„í•´ íŒŒì¼ í¬ê¸°ë¥¼ ì§€ì •(â€™0â€™ìœ¼ë¡œ ì§€ì •ì‹œ AOF íŒŒì¼ ì´ˆê¸°í™” ì—†ìŒ) |

### redis.conf ì„¤ì • ë°©ì‹

ë ˆë””ìŠ¤ ì„œë²„ê°€ ì‹œì‘í•  ë•Œ ì–´ë–¤ ë°ì´í„° íŒŒì¼ì„ ì½ì„ì§€ëŠ” redis.conf ì„¤ì • íŒŒì¼ì˜ appendonlyfile ì„¤ì •ì„ ë”°ë¥¸ë‹¤.

```jsx
appendonly yes
```

- `appendonly yes` : `aof` íŒŒì¼ì„ ì½ìŒ
- `appendonly no` : `rdb` íŒŒì¼ì„ ì½ìŒ

### AOF íŒŒì¼ëª… ì§€ì •

Append only file ëª…ì„ ì§€ì •í•˜ëŠ” íŒŒë¼ë¯¸í„°ì´ë‹¤.

ì´ íŒŒë¼ë¯¸í„°ëŠ” appendonlyê°€ yesì¼ ë•Œ ì ìš©ëœë‹¤.

config set ëª…ë ¹ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ì—†ë‹¤.

```jsx
appendfilename "appendonly.aof"
```

### AOFì— ê¸°ë¡ë˜ëŠ” ì‹œì  ì§€ì •

appendfsyncëŠ” appendonly íŒŒì¼ì— `ë°ì´í„°ê°€ ì“°ì—¬ì§€ëŠ” ì‹œì `ì„ ì •í•˜ëŠ” íŒŒë¼ë¯¸í„°

AOFëŠ” íŒŒì¼ ì— ì €ì¥í•  ë•Œ íŒŒì¼ì„ ë²„í¼ ìºì‹œì— ì €ì¥í•˜ê³  ì ì ˆí•œ ì‹œì ì— ì´ ë°ì´í„°ë¥¼ ë””ìŠ¤í¬ë¡œ ì €ì¥í•˜ëŠ”ë° appendfsync ëŠ” ë””ìŠ¤í¬ì™€ ë™ê¸°í™”ë¥¼ ì–¼ë§ˆë‚˜ ìì£¼ í•  ê²ƒì¸ì§€ì— ëŒ€í•´ ì„¤ì •í•˜ëŠ” ê°’ìœ¼ë¡œ 3ê°€ì§€ ì˜µì…˜ì´ ìˆë‹¤

- always : ëª…ë ¹ ì‹¤í–‰ì‹œë§ˆë‹¤ AOFì— ê¸°ë¡, ë°ì´í„° ìœ ì‹¤ì€ ê±°ì˜ ì—†ì§€ë§Œ ì„±ëŠ¥ì´ ë§¤ìš° ë–¨ì–´ì§„ë‹¤.
- everysec : 1ì´ˆë§ˆë‹¤ AOFì— ê¸°ë¡ (ì´ ì˜µì…˜ì„ ê¶Œì¥í•¨)
- no : AOFì— ê¸°ë¡í•˜ëŠ” ì‹œì ì„ OSê°€ ì •í•¨ (ì¼ë°˜ì ì¸ ë¦¬ëˆ…ìŠ¤ì˜ ë””ìŠ¤í¬ ê¸°ë¡ ê°„ê²© 30ì´ˆ)
       ë°ì´í„° ìœ ì‹¤ ê°€ëŠ¥ì„± ìˆìŒ

### AOF Rewrite ì„¤ì •

ì²˜ìŒ Redis ì„œë²„ê°€ ì‹œì‘í•  ì‹œì ì˜ AOF íŒŒì¼ ì‚¬ì´ì¦ˆê°€ 100%ì´ìƒ ì»¤ì§€ë©´ rewriteí•˜ê²Œ ë˜ì–´ìˆë‹¤. 

ë§Œì•½ ë ˆë””ìŠ¤ ì„œë²„ ì‹œì‘ì‹œ AOF íŒŒì¼ ì‚¬ì´ì¦ˆê°€ 0ì´ì—ˆë‹¤ë©´, auto-aof-rewrite-min-sizeë¥¼ ê¸°ì¤€ìœ¼ë¡œ rewriteí•œë‹¤.

í•˜ì§€ë§Œ min-sizeê°€ 64mb ì´í•˜ì´ë©´ rewriteë¥¼ í•˜ì§€ ì•ŠëŠ”ë°, ì´ëŠ” íŒŒì¼ì´ ì‘ì„ ë•Œ rewriteê°€ ìì£¼ ë°œìƒí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•¨ì´ë‹¤.

```jsx
// AOF íŒŒì¼ ì‚¬ì´ì¦ˆê°€ íŠ¹ì • í¼ì„¼íŠ¸ ì´ìƒ ì»¤ë””ë©´ rewriteí•œë‹¤.
// ë¹„êµ ê¸°ì¤€ì€ ë ˆë””ìŠ¤ ì„œë²„ê°€ ì‹œì‘í•  ì‹œì ì˜ AOF íŒŒì¼ ì‚¬ì´ì¦ˆì´ë‹¤.
// 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ rewriteë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.
auto-aof-rewrite-percentage 100

// AOF íŒŒì¼ ì‚¬ì´ì¦ˆê°€ 64mb ì´í•˜ë©´ rewriteë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤.
// íŒŒì¼ì´ ì‘ì„ ë•Œ rewriteê°€ ìì£¼ ë°œìƒí•˜ëŠ” ê²ƒì„ ë§‰ì•„ì¤€ë‹¤.
auto-aof-rewrite-min-size 64mb
```

### AOF íŒŒì¼ì„ ì´ìš©í•œ ë³µêµ¬í•˜ê¸°

```jsx
set a 11
set b 22
set c 33

> keys *
1) "b"
2) "a"
3) "c"

> flushall
OK

>keys *
(empty list or set)

// appendonly.aof íŒŒì¼ì— ë¡œë“œê°€ ìŒ“ì¸ë‹¤
// AOFëŠ” ëª…ë ¹ ì‹¤í–‰ ìˆœì„œëŒ€ë¡œ í…ìŠ¤íŠ¸ë¡œ ì“°ì—¬ì§€ë©° í¸ì§‘ ê°€ëŠ¥
// '*' ëŠ” ëª…ë ¹ ì‹œì‘ì„ ë‚˜íƒ€ë‚¸ë‹¤. ìˆ«ìëŠ” ëª…ë ¹ê³¼ëŠ” ì¸ìˆ˜ì˜ ê°œìˆ˜ì´ë‹¤
// '$' ëŠ” ëª…ë ¹ì´ë‚˜ ì¸ìˆ˜, ë°ì´í„°ì˜ ë°”ì´íŠ¸ ìˆ˜ì´ë‹¤. (í•œê¸€ì€ UTF-8ë¡œ í–ˆì„ ê²½ìš° í•œ ê¸€ìì— 3byte)
*2
$6
SELECT
$1
0
*3
$3
set
$1
a
$2
11
*3
$3
set
$1
b
$2
22
*3
$3
set
$1
c
$2
33
*1
$8
flushall

// ì ¤ ë§ˆì§€ë§‰ì˜ flushall ëª…ë ¹ì–´ë¥¼ ì§€ì›Œì£¼ê³  ì €ì¥í•´ì¤€ë‹¤.
// ë‹¤ì‹œ Redisë¥¼ ì‹¤í–‰í•´ì£¼ë©´ ë°ì´í„°ê°€ ë³µêµ¬ë˜ì–´ ìˆë‹¤.
```

# ì„ íƒ ê¸°ì¤€

## RDB ì‚¬ìš© ì£¼ì˜í•  ì 

Redisì— ì¥ì• ê°€ ë°œìƒí–ˆì„ ë•Œ ë°±ì—… ì‹œì ì„ ì œì™¸í•œ ì¤‘ê°„ ì‹œì ì—ì„œ ë°œìƒí•œ ë°ì´í„°ëŠ” ìœ ì‹¤ë  ìˆ˜ ìˆë‹¤.

rdb íŒŒì¼ì„ ìƒì„±í•˜ëŠ” cli ëª…ë ¹ì–´ saveëŠ” single threadë¡œ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ì‘ì—…ì´ ì™„ë£Œë˜ê¸°ê¹Œì§€ ëª¨ë“  ìš”ì²­ì´ ëŒ€ê¸°í•˜ê²Œ ëœë‹¤.

ë”°ë¼ì„œ bgsave ì»¤ë§¨ë“œë¡œ background ìì‹ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ RDBì‘ì—… ìˆ˜í–‰í•˜ë„ë¡ í•  ê²ƒì„ ê¶Œì¥ë˜ëŠ” í¸ì´ë‹¤

ê·¸ëŸ¬ë‚˜ bgì»¤ë§¨ë“œ ìˆ˜í–‰ì‹œì—” `memory ì‚¬ìš©ë¥ `ì„ ì¡°ì‹¬í•´ì•¼ í•œë‹¤.

redis ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©ì¤‘ì¸ ë°ì´í„°ëŠ” ëª¨ë‘ ë©”ëª¨ë¦¬ ìœ„ì— ì‡ëŠ”ë° ì´ë¥¼ ì„œë¹„ìŠ¤ ì˜í–¥ ì—†ì´ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•´ì„œëŠ” Copy-on-Wrtie(COW) ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.
ìì‹ í”„ë¡œì„¸ìŠ¤ fork() í›„ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì˜ ë©”ëª¨ë¦¬ì—ì„œ ì‹¤ì œë¡œ ë³€ê²½ì´ ë°œìƒí•œ ë¶€ë¶„ë§Œ ë³µì‚¬í•˜ê²Œ ë˜ëŠ”ë° ë§Œì¼ write ì‘ì—…ì´ ë§ì•„ì„œ ë¶€ëª¨ í˜ì´ì§€ ì „ë¶€ì— ë³€ê²½ì´ ë°œìƒí•˜ê²Œ ë˜ë©´ ë¶€ëª¨ í˜ì´ì§€ ì „ë¶€ë¥¼ ë³µì‚¬í•˜ê²Œ ë˜ëŠ” í˜„ìƒì´ ë°œìƒí•˜ê²Œ ëœë‹¤.

## AOF ì‚¬ìš© ì£¼ì˜í•  ì 

ë‹¨ìˆœí•˜ê²Œ ë´¤ì„ ë•Œ ì“°ê¸° ì‘ì—…ì˜ ê¸°ë¡ì„ ì €ì¥í•´ ë¶ˆëŸ¬ì˜¤ëŠ” í˜•ì‹ìœ¼ë¡œ ë³µêµ¬ë¥¼ í•˜ê¸° ë•Œë¬¸ì— ì•ˆì •ì ì´ë©° ì´ìƒì ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆë‹¤ í•˜ì§€ë§Œ ê·¸ë ‡ì§€ ì•Šë‹¤

ì˜ˆë¥¼ ë“¤ì–´ 100ë²ˆì˜ increment ì‘ì—…ì„ í†µí•´ 0ì˜ ë°ì´í„°ë¥¼ 100ìœ¼ë¡œ ë§Œë“¤ì—ˆë‹¤ê³  í–ˆì„ ë•Œ 
ìµœì¢…ì ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆëŠ” ë°ì´í„°ëŠ” 100ì´ì§€ë§Œ ë¶ˆí•„ìš”í•˜ê²Œ 100ë²ˆì˜ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•œë‹¤. 
ë¿ë§Œ ì•„ë‹ˆë¼ RDB ë°©ì‹ì— ë¹„í•´ ë°±ì—… ë°ì´í„°ê°€ í¬ê¸°ë„ í•˜ê³  , ì„œë²„ ìì› ë˜í•œ ë§ì´ ì¡ì•„ë¨¹ëŠ” í¸ì´ë‹¤.

ë”°ë¼ì„œ Redis ê³µì‹ ë¬¸ì„œì—ì„œëŠ” RDBì™€ AOF ë°©ì‹ì„ ì ì ˆíˆ í˜¼ì¬í•´ì„œ ì‚¬ìš©í•  ê²ƒì„ ê¶Œì¥í•œë‹¤.

## RDB VS AOF

Redisë¥¼ ë‹¨ìˆœíˆ ìºì‹œ ê¸°ëŠ¥ìœ¼ë¡œë§Œ ì‚¬ìš©ì„ í•œë‹¤ë©´ êµ³ì´ ë°±ì—…ì„ í•  í•„ìš”ê°€ ì—†ë‹¤. ì €ì¥ ê³µê°„ì´ ë‚­ë¹„ê°€ ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

ë°±ì—…ì€ í•„ìš”í•˜ì§€ë§Œ ì–´ëŠ ì •ë„ì˜ ë°ì´í„° ì†ì‹¤ì´ ë°œìƒí•´ë„ ê´œì°®ì€ ê²½ìš° RDBë¥¼ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•œë‹¤.
redis.conf íŒŒì¼ì—ì„œ SAVE ì˜µì…˜ì„ ì ì ˆí•˜ê²Œ ë³€ê²½í•´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```jsx
SAVE 900 1 // 900ì´ˆ ë™ì•ˆ 1ê°œ ì´ìƒì˜ í‚¤ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ RDS íŒŒì¼ ì¬ì‘ì„±

```

í•˜ì§€ë§Œ, ì¥ì•  ìƒí™© ì§ì „ê¹Œì§€ ëª¨ë“  ë°ì´í„°ê°€ ë³´ì¥ë˜ì–´ì•¼ í•  ê²½ìš° AOFë¥¼ ì‚¬ìš©í•œë‹¤.

```jsx
appendfsync everysec
```

ì‚¬ì‹¤ RDSì™€ AOFì˜ ì¥ë‹¨ì ì„ ìƒì‡„í•˜ê¸° ìœ„í•´ ë‘ê°€ì§€ ë°©ë²•ì„ í˜¼ìš©í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤

- ì£¼ê¸°ì ìœ¼ë¡œ RDBë¡œ ë°±ì—…í•˜ê³ , snapshotê¹Œì§€ì˜ ì €ì¥ì„ AOF ë°©ì‹ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ì‹ìœ¼ë¡œ í˜¼ìš©

ì´ë ‡ê²Œ í•˜ë©´ ì„œë²„ê°€ restartí•  ë•Œ ë°±ì—…ëœ snapshotì„ reloadí•˜ê³  ë¹„êµì  ì ì€ ì–‘ì˜ AOF ë¡œê·¸ë§Œ replayí•˜ë©´ ë˜ê¸° ë•Œë¬¸ì— restart ì‹œê°„ì„ ì ˆì•½í•˜ê³  ë°ì´í„°ì˜ ì†ì‹¤ì˜ ìµœì†Œí™” í•  ìˆ˜ ìˆë‹¤.

# Indexing

ì¸ë±ì‹±ì´ë€ ë°ì´í„°ë¥¼ ë³´ë‹¤ ë¹ ë¥´ê²Œ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ ì •ë ¬ëœ ë°ì´í„° êµ¬ì¡°ë¥¼ í™œìš©í•˜ëŠ” ê¸°ë²•ì´ë‹¤

## Redisì—ì„œ Indexingì„ í™œìš©í•˜ëŠ” ë°©ë²•

RedisëŠ” ë°ì´í„°êµ¬ì¡°ê°€ ë‹¨ìˆœí•œ key-value ì €ì¥ì†Œê°€ ì•„ë‹ˆë¼, `List, Set, Sorted, Hash` ê°™ì€ ë‹¤ì–‘í•œ ìë£Œêµ¬ì¡°ë¥¼ ì œê³µ
ì´ë¥¼ ì˜ í™œìš©í•˜ë©´ íš¨ìœ¨ì ì¸ `ê²€ìƒ‰ ì¸ë±ìŠ¤`ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

### Sorted Setì„ í™œìš©í•œ ê²€ìƒ‰ ì¸ë±ìŠ¤

ZADD ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ì •ë ¬ëœ ë°ì´í„°ë¥¼ ì €ì¥

ZRANGEì™€ ê°™ì€ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ë¹ ë¥´ê²Œ ê²€ìƒ‰ ê°€ëŠ¥

```jsx
ZADD users:age 25 "user1"
ZADD users:age 30 "user2"
ZADD users:age 35 "user3"

ZRANGE users:age 0 -1 WITHSCORES 
// ê²°ê³¼ ["user1", 25, "user2", 30, "user3", 35]
// íŠ¹ì • ë²”ìœ„ì˜ ë°ì´í„° ê²€ìƒ‰ì´ ë¹ ë¥´ë‹¤
```

### Hashë¥¼ í™œìš©í•œ ë¹ ë¥¸ ì¡°íšŒ

ì‚¬ìš©ì ì •ë³´ ê°™ì€ ë°ì´í„°ë¥¼ key-value í˜•íƒœë¡œ ì €ì¥

```jsx
// êµ¬ì¡°ì²´ í˜•ëŒ€ë¡œ ì €ì¥ì´ë¨
HSET user:1001 name "John Doe" age 30 email "john@mail.com

// íŠ¹ì • í•„ë“œ ê²€ìƒ‰ : keyê°’ ì•ˆì—ì„œ ì›í•˜ëŠ” ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
HGET user:1001 name

// ê²°ê³¼ : ê´€ê³„í˜• DBë³´ë‹¤ ë¹ ë¥¸ ê²€ìƒ‰ì´ ê°€ëŠ¥í•˜ë‹¤
"John Doe" 
```

# TTL(Time-To-Live)ì´ë€

ë°ì´í„°ì˜ ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ëŠ” ê¸°ëŠ¥ì´ë‹¤
íŠ¹ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ì–´ ë©”ëª¨ë¦¬ë¥¼ ì ˆì•½í•˜ê³  ì˜¤ë˜ëœ ë°ì´í„°ì˜ ê°±ì‹ ì„ ìœ ë„í•œë‹¤.

```jsx
SETEX user:1001 60 "John Doe" // 60ì´ˆ í›„ ìë™ ì‚­ì œ

EXPIRE user:1001 30 // ê¸°ì¡´ í‚¤ì˜ TTLì„ 30ì´ˆë¡œ ë³€ê²½

TTL user:1001 // ë‚¨ì€ TTL í™•ì¸
```

# LRU(Least Recently Used) ì•Œê³ ë¦¬ì¦˜

ë©”ëª¨ë¦¬ ê³µê°„ì´ ë¶€ì¡±í•  ë•Œ `ê°€ì¥ ì˜¤ë˜ ì‚¬ìš©í•˜ì§€ ì•Šì€ ë°ì´í„°`ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ë°©ì‹ì´ë‹¤

ì™œ ì‚¬ìš©í•˜ëŠ”ê°€?

1. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ìµœì í™”í•˜ê³ , ì„±ëŠ¥ ìœ ì§€
2. ìì£¼ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ëŠ” ìœ ì§€í•˜ê³ , ëœ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ì‚­ì œ
3. ì œí•œëœ ë¦¬ì†ŒìŠ¤ ë‚´ì—ì„œ ìºì‹± íš¨ìœ¨ ê·¹ëŒ€í™”

## LRU ì •ì±… ì¢…ë¥˜

1. volatile-lru : TTLì´ ì„¤ì •ëœ í‚¤ë“¤ ì¤‘ LRU ë°©ì‹ìœ¼ë¡œ ì œê±°
2. allkeys-lru : ëª¨ë“  í‚¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ LRU ë°©ì‹ìœ¼ë¡œ ì œê±°
3. volatile-ttl : TTLì´ ì§§ì€ ë°ì´í„°ë¶€í„° ì‚­ì œ
4. volatile-random : TTLì´ ìˆëŠ” í‚¤ ì¤‘ ëœë¤ ì‚­ì œ
5. allkeys-random : ëª¨ë“  í‚¤ ì¤‘ ëœë¤ ì‚­ì œ

## LRU ì„¤ì • ë°©ë²•

```jsx
CONFIG SET maxmemory 100mb
CONFIG SET maxmemory-policy allkeys-lru
```

# TTL + LRU í™œìš© ì˜ˆ

```jsx
const redis = require('redis');
const redisClient = redis.createClient();
redisClient.connect();

// ì‚¬ìš©ì ê²€ìƒ‰ ê¸°ë¡ ì¶”ê°€ (ìµœëŒ€ 10ê°œ ì €ì¥)
async function addSearchHistory(userId, keyword) {
  const key = `search_history:${userId}`;

  // ìµœê·¼ ê²€ìƒ‰ì–´ë¥¼ ì™¼ìª½ì— ì¶”ê°€
  await redisClient.lPush(key, keyword); // ìƒˆë¡œìš´ ê²€ìƒ‰ì–´ë¥¼ ì•ìª½ì— ì¶”ê°€í•œë‹¤.
  
  // 10ê°œ ì´ìƒ ì €ì¥ë˜ì§€ ì•Šë„ë¡ ì œí•œ
  await redisClient.lTrim(key, 0, 9);// 10ê°œê¹Œì§€ë§Œ ì €ì¥ì´ ë˜ë„ë¡ ì œí•œ

  // TTL ì„¤ì • (24ì‹œê°„ í›„ ìë™ ì‚­ì œ)
  await redisClient.expire(key, 86400); // 24ì‹œê°„ í›„ ìë™ ì‚­ì œ ( TTLì ìš©)
}

// ì‚¬ìš©ì ê²€ìƒ‰ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
async function getSearchHistory(userId) {
  const key = `search_history:${userId}`;
  return await redisClient.lRange(key, 0, -1);
}

// í…ŒìŠ¤íŠ¸ ì‹¤í–‰
addSearchHistory(1001, "Redis LRU ì•Œê³ ë¦¬ì¦˜");
addSearchHistory(1001, "TTL í™œìš©í•˜ê¸°");
setTimeout(async () => {
  console.log(await getSearchHistory(1001)); // ìµœê·¼ 2ê°œ ê²€ìƒ‰ì–´ ì¡°íšŒ
}, 1000);

# ìºì‹± ì •ì±… - ì •ì  VS ë™ì  ìºì‹± ì°¨ì´

ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ìºì‹±ì„ ì ìš©í•˜ëŠëƒì— ë”°ë¼ ì„±ëŠ¥ ìµœì í™”, ì‘ë‹µ ì†ë„, ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.

## ìºì‹± ì •ì±… ì´ë€?

ìºì‹±ì€ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  í™œìš©í•˜ëŠ” ë°©ì‹ì— ë”°ë¼ `ì •ì  ìºì‹±`(Static Caching)ê³¼ `ë™ì  ìºì‹±`(Dynamic Caching)ìœ¼ë¡œ ë‚˜ë‰œë‹¤.

## ì •ì  ìºì‹±(Static Caching)

ìì£¼ ë³€í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ë¥¼ ì¼ì • ì‹œê°„ ë™ì•ˆ ê·¸ëŒ€ë¡œ ìºì‹±í•˜ëŠ” ë°©ì‹

ë°ì´í„°ê°€ ìì£¼ ê°±ì‹ ë˜ì§€ ì•ŠëŠ” ê²½ìš° ìœ ìš©

ì˜ˆ) HTMLí˜ì´ì§€, ì´ë¯¸ì§€, CSSíŒŒì¼, API ì‘ë‹µ, ìƒí’ˆ ëª©ë¡

TTLë¡œ ë§Œë£Œëœ ì‹œê°„ ì„¤ì • í›„ ìë™ ì‚­ì œ

```jsx
SETEX home_page 3600 "<html>...</html>
```

- APIì‘ë‹µì„ Redisì— ì €ì¥ í›„ ì¼ì • ì‹œê°„ ë™ì•ˆ ì‚¬ìš©

```jsx
const redis = require('redis');
const axios = require('axios');

const redisClient = redis.createClient();
redisClient.connect();

// ì™¸ë¶€ APIì—ì„œ ë‰´ìŠ¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
async function fetchNewsFromAPI() {
  const response = await axios.get('https://newsapi.org/v2/top-headlines?country=us&apiKey=YOUR_API_KEY');
  return response.data.articles;
}

// ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ìºì‹±í•˜ì—¬ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
async function getNews() {
  const cacheKey = 'top_news';
  
  // 1ï¸âƒ£ Redisì—ì„œ ìºì‹œ í™•ì¸
  const cachedNews = await redisClient.get(cacheKey);
  if (cachedNews) {
    console.log("âœ… ìºì‹œì—ì„œ ë‰´ìŠ¤ ë°ì´í„° ë°˜í™˜!");
    return JSON.parse(cachedNews);
  }

  // 2ï¸âƒ£ ìºì‹œì— ì—†ìœ¼ë©´ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
  console.log("âŒ ìºì‹œì— ì—†ìŒ. APIì—ì„œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°...");
  const news = await fetchNewsFromAPI();

  // 3ï¸âƒ£ Redisì— ì €ì¥ (60ì´ˆ ë™ì•ˆ ìºì‹±)
  await redisClient.setEx(cacheKey, 60, JSON.stringify(news));

  return news;
}

// ì‹¤í–‰
getNews().then(console.log);

```

### ì¥ì 

ìºì‹œ ìœ ì§€ë¹„ìš©ì´ ì ê³ , ë¹ ë¥¸ ì‘ë‹µ ê°€ëŠ¥

### ë‹¨ì 

ë°ì´í„° ë³€ê²½ì´ ë°œìƒí•˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ê°±ì‹ í•´ì•¼ í•œë‹¤.

## ë™ì  ìºì‹±(Dynamic Caching)

ë°ì´í„°ê°€ ìì£¼ ë³€ê²½ë˜ê±°ë‚˜, ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ìºì‹± ë‚´ìš©ì´ ë‹¬ë¦¬ì§€ëŠ” ë°ì´í„°ë¥¼ ìºì‹±í•˜ëŠ” ë°©ì‹

ìš”ì²­ë§ˆë‹¤ ë‹¤ë¥¸ ë°ì´í„°ê°€ ë°˜í™˜ë  ê°€ëŠ¥ì„±ì´ ë†’ìŒ

ìºì‹± ê¸°ê°„ì´ ì§§ê±°ë‚˜, ìš”ì²­ ë³„ë¡œ ì €ì¥ í•„ìš”

ì˜ˆ ) ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ëŒ€ì‹œë³´ë“œ, `ì‹¤ì‹œê°„` ì£¼ì‹ ê°€ê²©, ì‚¬ìš©ìë³„ ë§ì¶¤ ì¶”ì²œ ì‹œìŠ¤í…œ

```jsx
// ğŸ’¡ ì‚¬ìš©ìë³„ ë°ì´í„°ë¥¼ ê°œë³„ ìºì‹±

async function getUserDashboard(userId) {
  const cacheKey = `user_dashboard:${userId}`;

  // 1ï¸âƒ£ Redisì—ì„œ ìºì‹œ í™•ì¸
  const cachedDashboard = await redisClient.get(cacheKey);
  if (cachedDashboard) {
    console.log(`âœ… ì‚¬ìš©ì ${userId}ì˜ ìºì‹œëœ ëŒ€ì‹œë³´ë“œ ë°˜í™˜`);
    return JSON.parse(cachedDashboard);
  }

  // 2ï¸âƒ£ ìºì‹œì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜¤ê¸° 
  console.log(`âŒ ì‚¬ìš©ì ${userId}ì˜ ëŒ€ì‹œë³´ë“œê°€ ìºì‹œì— ì—†ìŒ. DB ì¡°íšŒ...`);
  const userDashboard = { userId, balance: Math.random() * 1000, notifications: 3 };

  // 3ï¸âƒ£ Redisì— ì €ì¥ (30ì´ˆ ë™ì•ˆ ìºì‹±)
  await redisClient.setEx(cacheKey, 30, JSON.stringify(userDashboard));

  return userDashboard;
}

// ì‹¤í–‰
getUserDashboard(1001).then(console.log);

```

### ì¥ì 

ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜ ê°€ëŠ¥

### ë‹¨ì 

ìºì‹± ê´€ë¦¬ê°€ ì–´ë µê³ , DB ë¶€í•˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆìŒ

## ì •ì  VS ë™ì  ìºì‹± ë¹„êµ

ë°ì´í„°ì˜ ë³€ê²½ ë¹ˆë„ì™€ TTL ì„¤ì • ë°©ì‹ì— ë”°ë¼ ì–´ëŠ ê²ƒì„ ì‚¬ìš©í• ì§€ê°€ ê²°ì •ëœë‹¤.

| í•­ëª© | ì •ì  ìºì‹± | ë™ì  ìºì‹± |
| --- | --- | --- |
| ë°ì´í„° ë³€ê²½ ë¹ˆë„ | ê±°ì˜ ë³€í•˜ì§€ ì•ŠìŒ | ìì£¼ ë³€ê²½ë¨ |
| ìºì‹± ê¸°ê°„ | ë¹„êµì  ê¸¸ê²Œ ì„¤ì • ê°€ëŠ¥ | ì§§ê±°ë‚˜ ìš”ì²­ë³„ ìºì‹± í•„ìš” |
| TTL ì„¤ì • | ì¼ë°˜ì ìœ¼ë¡œ ì„¤ì • | ìš”ì²­ ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ |
| ì‚¬ìš© ì‚¬ë¡€ | HTML, ì´ë¯¸ì§€, API ì‘ë‹µ | ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ, ì‹¤ì‹œê°„ ë°ì´í„° |
| ì˜ˆì œ | ë‰´ìŠ¤ ì‹œê°€ ìºì‹± | ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ |
| ê°±ì‹  ë°©ë²• | TTL ë§Œë£Œ ì „ê¹Œì§€ ë™ì¼í•œ ë°ì´í„° ìœ ì§€ | ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ë°ì´í„° ì €ì¥ ê°€ëŠ¥ |
| ìºì‹± í‚¤ ë°©ì‹ | cache_key(ê³ ì • í‚¤) | cache_key:user_id(ìœ ì €ë³„ í‚¤) |

## ì •ì  + ë™ì  ìºì‹±ì„ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ì „ëµ

ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì •ì  & ë™ì  ìºì‹±ì„ `í˜¼í•©í•˜ì—¬ ì‚¬ìš©`í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤

```jsx
// ì •ì  ìºì‹± : íŠ¸ë Œë”© ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ (30ë¶„ TTL)
// ë™ì  ìºì‹± : ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡ (30ì´ˆ TTL)

async function getDashboardWithNews(userId) {
  const newsKey = 'trending_news';
  const userKey = `user_dashboard:${userId}`;

  // 1ï¸âƒ£ ë‰´ìŠ¤ ë°ì´í„° ìºì‹± (ì •ì  ìºì‹±)
  let news = await redisClient.get(newsKey);
  if (!news) {
    news = await fetchNewsFromAPI();
    await redisClient.setEx(newsKey, 1800, JSON.stringify(news)); // 30ë¶„ ìºì‹±
  } else {
    news = JSON.parse(news);
  }

  // 2ï¸âƒ£ ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ ìºì‹± (ë™ì  ìºì‹±)
  let userDashboard = await redisClient.get(userKey);
  if (!userDashboard) {
    userDashboard = { userId, balance: Math.random() * 1000, notifications: 3 };
    await redisClient.setEx(userKey, 30, JSON.stringify(userDashboard)); // 30ì´ˆ ìºì‹±
  } else {
    userDashboard = JSON.parse(userDashboard);
  }

  return { news, userDashboard };
}

// ì‹¤í–‰
getDashboardWithNews(1001).then(console.log);
```

# Locking & ë™ì‹œì„± ì´ìŠˆ í•´ê²°

Redisë¥¼ ì‚¬ìš©í•˜ë©´ ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
íŠ¹íˆ, `SETNX`(Set if Not Exists)ì™€ `EXPIRE`ë¥¼ í™œìš©í•œ `ë¶„ì‚° LOCK`ì„ ì‚¬ìš©í•˜ë©´ 
ìºì‹œ ì¼ê´€ì„± ìœ ì§€ ë° Cache Stampede ë°©ì§€ê°€ ê°€ëŠ¥í•˜ë‹¤

<aside>
ğŸ’¡

Cache Stampedeë€?
ìºì‹œê°€ ë§Œë£Œë˜ëŠ” ìˆœê°„ ë‹¤ìˆ˜ì˜ ìš”ì²­ì´ ë™ì‹œì— DBë¡œ ëª°ë ¤ ê³¼ë¶€í™”ê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œ

í•´ê²° ë°©ë²• 

1. ì¡°ê¸° ê°±ì‹  : TTLì´ ëë‚˜ê¸° ì „ì— ë¯¸ë¦¬ ê°±ì‹ 
2. ëœë¤ TTL ì ìš© : ëª¨ë“  ìºì‹œê°€ ë™ì‹œì— ë§Œë£Œë˜ì§€ ì•Šë„ë¡ í•¨
3. Locking ìºì‹± : SETNX + EXPIRE ë¡œ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ê°±ì‹  í—ˆìš©
</aside>

## ë™ì‹œì„± ì´ìŠˆë€?

ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ê°™ì€ ë°ì´í„°ì— ì ‘ê·¼í•˜ë©´ì„œ ê²½ìŸ ì¡°ê±´(Race Condition)ì´ ë°œìƒí•˜ëŠ” ë¬¸ì œ

ìºì‹œ ìƒì‹ , DBì—…ë°ì´íŠ¸, ì‘ì—… í ê´€ë¦¬ì‹œ ë°ì´í„° ì •í•©ì„± ìœ ì§€ê°€ ì–´ë ¤ì›Œì§

ì˜ˆ ) ì—¬ëŸ¬ ìš”ì²­ì´ ë™ì‹œì— DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ìºì‹œì— ì €ì¥í•˜ë ¤ëŠ” ê²½ìš°

### ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤

```jsx
// case1 : ìºì‹œ ê°±ì‹  ì¤‘ Race Condition ë°œìƒ
// ì—¬ëŸ¬ ìš”ì²­ì´ ë™ì‹œì— ìºì‹œë¥¼ ê°±ì‹ í•˜ë ¤ê³  í•˜ë©´ ê°±ìŸ ì¡°ê±´ ë°œìƒ
// Cache Stampede ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

const cacheKey = "user_1001";

// 1ï¸âƒ£ ìºì‹œì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
let data = await redisClient.get(cacheKey);
if (!data) {
  // 2ï¸âƒ£ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜´ (ë‹¤ë¥¸ ìš”ì²­ë„ ë™ì‹œì— ìˆ˜í–‰ ê°€ëŠ¥)
  data = await fetchUserFromDB(1001);
  
  // 3ï¸âƒ£ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ê°™ì€ ë°ì´í„°ë¥¼ Redisì— ì €ì¥ (ê²½ìŸ ë°œìƒ)
  await redisClient.setEx(cacheKey, 60, JSON.stringify(data));
}

return JSON.parse(data);

```

## Redis Lockì„ ì´ìš©í•œ ë™ì‹œì„± ë¬¸ì œ í•´ê²° (SETNX + EXPIRE)

í•´ê²°ë°©ë²• : ë¶„ì‚° Lock ì ìš©

`SETNX`ì™€ `EXPIRE`ë¥¼ ì¡°í•©í•˜ë©´ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ìºì‹œë¥¼ ê°±ì‹ í•˜ë„ë¡ ì œì–´í•  ìˆ˜ ìˆë‹¤.

1. SETNX key value â†’ Keyê°€ ì—†ì„ ê²½ìš°ì—ë§Œ ì €ì¥ (Lock ì„¤ì •)
2. EXPIRE key TTL â†’ Lockì´ ì˜êµ¬ì ìœ¼ë¡œ ìœ ì§€ë˜ì§€ ì•Šë„ë¡ ë§Œë£Œ ì‹œê°„ ì„¤ì •

```jsx
async function getCachedDataWithLock(key, fetchFromDB) {
  const cachedData = await redisClient.get(key);
  if (cachedData) return JSON.parse(cachedData);

  const lockKey = `${key}:lock`;
  
  // 1ï¸âƒ£ Lock íšë“ (SETNX) -> ë§Œì•½ Lockì´ ì¡´ì¬í•˜ë©´ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ ëŒ€ê¸°
	// NX : true -> Lockì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ì—ë§Œ ì„¤ì •
	// EX : 10 -> ë§Œì•½ Lockì„ íšë“í•œ í›„ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤íŒ¨í•´ë„ 10ì´ˆ í›„ ìë™ í•´ì œ	 
  const lockAcquired = await redisClient.set(lockKey, "locked", { NX: true, EX: 10 });

  if (!lockAcquired) {
    console.log("ğŸ”’ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ìºì‹œ ê°±ì‹  ì¤‘... ëŒ€ê¸°");
    await new Promise((resolve) => setTimeout(resolve, 100)); // 100ms ëŒ€ê¸° í›„ ì¬ì‹œë„
    return getCachedDataWithLock(key, fetchFromDB);
  }

  try {
    // 2ï¸âƒ£ ìºì‹œì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì™€ ì €ì¥
    const newData = await fetchFromDB();
    await redisClient.setEx(key, 60, JSON.stringify(newData));

    return newData;
  } finally {
    // 3ï¸âƒ£ Lock í•´ì œ : ì‘ì—… ì™„ë£Œ í›„ LOCKì„ ì‚­ì œí•˜ì—¬ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ìºì‹± ê°€ëŠ¥í•˜ë„ë¡ í•¨
    await redisClient.del(lockKey);
  }
}

// ì‹¤í–‰
getCachedDataWithLock("user_1001", () => fetchUserFromDB(1001)).then(console.log);

```

## Lockingêµ¬í˜„ì‹œ ê³ ë ¤í•´ì•¼ í•  ì‚¬í•­

### Deadlock(êµì°©ìƒíƒœ) ë°©ì§€

ë§Œì•½ Lockì„ íšë“í•œ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤íŒ¨í•˜ë©´, Lockì´ ì˜êµ¬ì ìœ¼ë¡œ ìœ ì§€ë  ê°€ëŠ¥ì„±ì´ ìˆë‹¤

í•´ê²°ë°©ë²• â†’ TTLì„ ë°˜ë“œì‹œ ì„¤ì •(EXPIRE)

```jsx
// Lockì´ í•´ì œë  ë•Œê¹Œì§€ ì¼ì • ì‹œê°„ ëŒ€ê¸° í›„ ì¬ì‹œë„
await redisClient.set(lockKey, "locked", { NX: true, EX: 10 });
```

### ìºì‹œ ê°±ì‹  ì¤‘ì¸ ê²½ìš°, ëŒ€ê¸° í›„ ì¬ì‹œë„

ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ Lockì„ íšë“í•˜ê³  ìºì‹œë¥¼ ê°±ì‹  ì¤‘ì´ë©´ ëŒ€ê¸° í›„ ì¬ì‹œë„

```jsx
// Lockì´ í•´ì œë  ë•Œê¹Œì§€ ì¼ì • ì‹œê°„ ëŒ€ê¸° í›„ ì¬ì‹œë„ 
if (!lockAcquired) {
  console.log("ğŸ”’ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ìºì‹œ ê°±ì‹  ì¤‘... ëŒ€ê¸°");
  await new Promise((resolve) => setTimeout(resolve, 100)); // 100ms ëŒ€ê¸°
  return getCachedDataWithLock(key, fetchFromDB);
}

```

## ë¶„ì‚° í™˜ê²½ì—ì„œì˜ Redis Lock

### Race Condition(ê²½ìŸì¡°ê±´)ì´ë€

ë‘ ê°œ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤(ë˜ëŠ” ìŠ¤ë ˆë“œ)ê°€ ë™ì‹œì— ê°™ì€ ìì›(ë°ì´í„°, ë³€ìˆ˜ ë“±)ì— ì ‘ê·¼í•˜ë©´ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ë™ì‘ì´ ë°œìƒí•˜ëŠ” ë¬¸ì œ

### ì–´ë–»ê²Œ ë°œìƒí• ê¹Œ?

1. ì—¬ëŸ¬ ìš”ì²­ì´ ë™ì‹œì— ê°™ì€ ë°ì´í„°ë¥¼ ì½ê³  ìˆ˜ì •
2. ìš”ì²­ ê°„ ì‹¤í–‰ ìˆœì„œê°€ ë³´ì¥ë˜ì§€ ì•ŠìŒ
3. ìµœì¢… ê²°ê³¼ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ë³€í˜•ë¨ (ë°ì´í„° ë¶ˆì¼ì¹˜ ë°œìƒ)

### Race Condition ì˜ˆì œ: ì€í–‰ ê³„ì¢Œ ì”ì•¡ ì²˜ë¦¬

```jsx
async function withdraw(userId, amount) {
  const balanceKey = `balance:${userId}`;

  // 1ï¸âƒ£ í˜„ì¬ ì”ì•¡ ì¡°íšŒ
  let balance = await redisClient.get(balanceKey);
  if (!balance) balance = 1000; // ì´ˆê¸°ê°’

  if (balance < amount) {
    console.log("âŒ ì”ì•¡ ë¶€ì¡±!");
    return false;
  }

  // 2ï¸âƒ£ ì¶œê¸ˆ ì²˜ë¦¬ (ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ì ‘ê·¼ ê°€ëŠ¥!)
  await redisClient.set(balanceKey, balance - amount);
  console.log(`âœ… ${amount}ì› ì¶œê¸ˆ ì™„ë£Œ! ë‚¨ì€ ì”ì•¡: ${balance - amount}`);

  return true;
}
```

- ë¬¸ì œì  : ë§Œì•½ ë‘ ê°œì˜ ì¶œê¸ˆ ìš”ì²­ì´ ë™ì‹œì— ì‹¤í–‰ ë˜ë©´?
    - ë‘ ìš”ì²­ì´ ê°™ì€ ì”ì•¡ì„ ê°€ì ¸ì˜´
    - ì²« ë²ˆì§¸ ìš”ì²­ : 1000 - 500 = 500
    - ë‘ ë²ˆì§¸ ìš”ì²­ : 1000 - 500 = 500 â‡’ ì”ì•¡ ì˜¤ë¥˜ ë°œìƒ!( ì •ìƒì ìœ¼ë¡œëŠ” 0ì›ì´ ë˜ì–´ì•¼ í•¨)

### í•´ê²°ë°©ë²•

- Locking ê¸°ë²•ì„ ì‚¬ìš©í•œë‹¤ (SETNX + EXPIRE)
    - í•˜ë‚˜ì˜ ìš”ì²­ë§Œ ì¶œê¸ˆì´ ê°€ëŠ¥í•˜ë„ë¡ ë™ì‹œì„± ì œì–´
    - LOCKì„ í†µí•´ Race Condition í•´ê²°
    - LOCKì´ ì˜êµ¬ì ìœ¼ë¡œ ìœ ì§€ë˜ì§€ ì•Šë„ë¡ EXPIRE ì„¤ì • (Deadlock ë°©ì§€)

```jsx
async function withdrawWithLock(userId, amount) {
  const balanceKey = `balance:${userId}`;
  const lockKey = `lock:${userId}`;

  // 1ï¸âƒ£ Lock ì„¤ì • (ë™ì‹œì— í•˜ë‚˜ì˜ ìš”ì²­ë§Œ ì²˜ë¦¬)
  const lock = await redisClient.set(lockKey, "locked", { NX: true, EX: 5 });
  if (!lock) {
    console.log("ğŸ”’ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì¶œê¸ˆ ì²˜ë¦¬ ì¤‘... ëŒ€ê¸°");
    await new Promise((resolve) => setTimeout(resolve, 100)); // 100ms ëŒ€ê¸° í›„ ì¬ì‹œë„
    return withdrawWithLock(userId, amount);
  }

  try {
    // 2ï¸âƒ£ í˜„ì¬ ì”ì•¡ ì¡°íšŒ
    let balance = await redisClient.get(balanceKey);
    if (!balance) balance = 1000;

    if (balance < amount) {
      console.log("âŒ ì”ì•¡ ë¶€ì¡±!");
      return false;
    }

    // 3ï¸âƒ£ ì¶œê¸ˆ ì²˜ë¦¬
    await redisClient.set(balanceKey, balance - amount);
    console.log(`âœ… ${amount}ì› ì¶œê¸ˆ ì™„ë£Œ! ë‚¨ì€ ì”ì•¡: ${balance - amount}`);

    return true;
  } finally {
    // 4ï¸âƒ£ Lock í•´ì œ
    await redisClient.del(lockKey);
  }
}

```

### ë¶„ì‚° í™˜ê²½ Redis Lock ì˜ˆì œ

ì‚¬ìš© ì˜ˆì‹œ : ìƒí’ˆ ì¬ê³  ê°ì†Œ ì²˜ë¦¬ 

```jsx
// Race Condition ë°©ì§€ -> Lockì„ ì‚¬ìš©í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìš”ì²­ë§Œ ì‹¤í–‰ ê°€ëŠ¥
// ì¬ê³  ì°¨ê° ì¤‘ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ë³€ê²½í•˜ëŠ” ë¬¸ì œ í•´ê²°
async function decreaseStock(productId, quantity) {
  const lockKey = `stock_lock:${productId}`;
  const stockKey = `stock:${productId}`;

  // 1ï¸âƒ£ Lock ì„¤ì •
  const lockAcquired = await redisClient.set(lockKey, "locked", { NX: true, EX: 5 });

  if (!lockAcquired) {
    console.log("ğŸ”’ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì¬ê³  ì²˜ë¦¬ ì¤‘... ëŒ€ê¸°");
    await new Promise((resolve) => setTimeout(resolve, 100));
    return decreaseStock(productId, quantity);
  }

  try {
    // 2ï¸âƒ£ í˜„ì¬ ì¬ê³  í™•ì¸
    let stock = await redisClient.get(stockKey);
    stock = stock ? parseInt(stock) : 0;

    if (stock < quantity) {
      console.log("âŒ ì¬ê³  ë¶€ì¡±!");
      return false;
    }

    // 3ï¸âƒ£ ì¬ê³  ì°¨ê°
    await redisClient.set(stockKey, stock - quantity);
    console.log(`âœ… ${quantity}ê°œ ìƒí’ˆ êµ¬ë§¤ ì™„ë£Œ! ë‚¨ì€ ì¬ê³ : ${stock - quantity}`);

    return true;
  } finally {
    // 4ï¸âƒ£ Lock í•´ì œ
    await redisClient.del(lockKey);
  }
}

// ì‹¤í–‰
decreaseStock("product_123", 2);

```

# ì¶œì²˜

[Redis - ì˜ì†í™”(Persistence)](https://galid1.tistory.com/799)

[[REDIS] ğŸ“š ìºì‹œ ë°ì´í„° ì˜êµ¬ ì €ì¥í•˜ëŠ” ë°©ë²• (RDB / AOF)](https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%98%81%EA%B5%AC-%EC%A0%80%EC%9E%A5%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%9D%98-%EC%98%81%EC%86%8D%EC%84%B1)
